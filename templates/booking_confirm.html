{% extends "base.html" %}
{% block title %}Confirm Booking - SkyDesk{% endblock %}
{% block content %}
{% set trip = payload.get('trip') or {} %}
{% set trip_dates = trip.get('dates') or {} %}
{% set other_pax = payload.get('other_pax') or [] %}
{% set other_pax_rows = other_pax if other_pax else [{}] %}
{% set accommodation = payload.get('accommodation') or [] %}
{% set accommodation_rows = accommodation if accommodation else [{}] %}
{% set flights = payload.get('flights') or [] %}
{% set flight_rows = flights if flights else [{}] %}
{% set services = payload.get('services') or [] %}
{% set service_rows = services if services else [{}] %}
{% set totals = payload.get('totals') or {} %}
{% set grand_total = totals.get('grand_total') or {} %}
{% set balance_total = totals.get('balance_remaining') or {} %}
{% set payments = payload.get('payments') or {} %}
{% set transactions_rows = transactions if transactions else [{}] %}
{% set status = payload.get('status') or {} %}
<div class="space-y-8">
  <div class="space-y-2">
    <p class="text-sm uppercase tracking-[0.3em] text-muted">Booking Intake</p>
    <h1 class="text-3xl font-semibold">Review parsed booking</h1>
    <p class="text-sm text-muted max-w-3xl">
      We ingested <span class="text-white">{{ original_filename or 'uploaded.pdf' }}</span>. Adjust any fields below before saving.
    </p>
    <div aria-hidden="true" class="h-px w-full bg-white/10"></div>
  </div>

  {% if error_message %}
    <div class="rounded-3xl border border-red-500/40 bg-red-500/15 p-4 text-sm text-red-100">
      {{ error_message }}
    </div>
  {% endif %}

  <form method="post" class="space-y-6">
    <input type="hidden" name="other_pax_count" value="{{ other_pax_rows|length }}">
    <input type="hidden" name="accommodation_count" value="{{ accommodation_rows|length }}">
    <input type="hidden" name="flights_count" value="{{ flight_rows|length }}">
    <input type="hidden" name="services_count" value="{{ service_rows|length }}">
    <input type="hidden" name="payments_txn_count" value="{{ transactions_rows|length }}">

    <section class="space-y-8 rounded-3xl border border-white/10 bg-white/5 p-6">
      <div class="grid gap-4 sm:grid-cols-2">
        <label class="flex flex-col gap-2 text-sm text-white/70">
          Lead ID
          <input name="lead_id" value="{{ payload.get('lead_id') or '' }}" maxlength="7" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50" required>
        </label>
        <label class="flex flex-col gap-2 text-sm text-white/70">
          Issued at (DD-MM-YYYY)
          <input name="issued_at" value="{{ payload.get('issued_at') or '' }}" placeholder="22-09-2025" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
        </label>
      </div>

      <label class="flex flex-col gap-2 text-sm text-white/70">
        Client name
        <input name="client_name" value="{{ payload.get('client', {}).get('name') or '' }}" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
      </label>

      <div class="space-y-4">
        <h2 class="text-xs uppercase tracking-[0.3em] text-white/50">Trip Overview</h2>
        <div class="grid gap-4 sm:grid-cols-2">
          <label class="flex flex-col gap-2 text-sm text-white/70">
            Destinations (comma or newline)
            <textarea name="trip_destinations" rows="2" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">{{ (trip.get('destinations') or trip.get('regions') or []) | join('\n') }}</textarea>
          </label>
          <label class="flex flex-col gap-2 text-sm text-white/70">
            Locations (comma or newline)
            <textarea name="trip_locations" rows="2" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">{{ (trip.get('locations') or []) | join('\n') }}</textarea>
          </label>
        </div>
        <div class="grid gap-4 sm:grid-cols-3">
          <label class="flex flex-col gap-2 text-sm text-white/70">
            Start date (YYYY-MM-DD)
            <input name="trip_start" value="{{ trip_dates.get('start') or '' }}" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
          </label>
          <label class="flex flex-col gap-2 text-sm text-white/70">
            End date (YYYY-MM-DD)
            <input name="trip_end" value="{{ trip_dates.get('end') or '' }}" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
          </label>
          <label class="flex flex-col gap-2 text-sm text-white/70">
            Nights
            <input name="trip_nights" value="{{ trip_dates.get('nights') or '' }}" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
          </label>
        </div>
      </div>

      <div class="space-y-3">
        <h2 class="text-xs uppercase tracking-[0.3em] text-white/50">Other Travellers</h2>
        {% for pax in other_pax_rows %}
          <div class="grid gap-3 rounded-2xl border border-white/10 bg-black/30 p-4 sm:grid-cols-2">
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Name
              <input name="other_pax-{{ loop.index0 }}-name" value="{{ pax.get('name') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Traveller type
              <input name="other_pax-{{ loop.index0 }}-pax_type" value="{{ pax.get('pax_type') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
          </div>
        {% endfor %}
      </div>

      <div class="space-y-3">
        <h2 class="text-xs uppercase tracking-[0.3em] text-white/50">Accommodation</h2>
        {% for stay in accommodation_rows %}
          <div class="grid gap-3 rounded-2xl border border-white/10 bg-black/30 p-4 lg:grid-cols-4">
            <label class="flex flex-col gap-2 text-xs text-white/70 lg:col-span-2">
              Property name
              <input name="accommodation-{{ loop.index0 }}-name" value="{{ stay.get('name') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Check-in
              <input name="accommodation-{{ loop.index0 }}-check_in" value="{{ stay.get('check_in') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Check-out
              <input name="accommodation-{{ loop.index0 }}-check_out" value="{{ stay.get('check_out') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Nights
              <input name="accommodation-{{ loop.index0 }}-nights" value="{{ stay.get('nights') if stay.get('nights') is not none else '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Room type
              <input name="accommodation-{{ loop.index0 }}-room_type" value="{{ stay.get('room_type') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Board
              <input name="accommodation-{{ loop.index0 }}-board" value="{{ stay.get('board') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Supplier reference
              <input name="accommodation-{{ loop.index0 }}-supplier_ref" value="{{ stay.get('supplier_ref') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
          </div>
        {% endfor %}
      </div>

      <div class="space-y-3">
        <h2 class="text-xs uppercase tracking-[0.3em] text-white/50">Flights</h2>
        {% for flight in flight_rows %}
          {% set segs = flight.get('segments') or [] %}
          {% set lays = flight.get('layovers') or [] %}
          <div class="space-y-3 rounded-2xl border border-white/10 bg-black/30 p-4">
            <div class="grid gap-3 sm:grid-cols-2">
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Carrier
                <input name="flights-{{ loop.index0 }}-carrier" value="{{ flight.get('carrier') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Route (e.g. BNE-LON)
                <input name="flights-{{ loop.index0 }}-route" value="{{ flight.get('route') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
            </div>
            <div class="grid gap-3 sm:grid-cols-3">
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Origin
                <input name="flights-{{ loop.index0 }}-origin" value="{{ flight.get('origin') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Destination
                <input name="flights-{{ loop.index0 }}-destination" value="{{ flight.get('destination') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
              <label class="flex flex-col gap-2 text-xs text-white/70">
                PNR / reference
                <input name="flights-{{ loop.index0 }}-pnr" value="{{ flight.get('pnr') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
            </div>
            <input type="hidden" name="flights-{{ loop.index0 }}-segments_json" value='{{ segs | tojson }}'>
            <input type="hidden" name="flights-{{ loop.index0 }}-layovers_json" value='{{ lays | tojson }}'>
            <div class="overflow-x-auto">
              <table class="w-full text-xs text-white/80">
                <thead class="text-white/50">
                  <tr>
                    <th class="text-left py-1 pr-2">Carrier</th>
                    <th class="text-left py-1 pr-2">Flight</th>
                    <th class="text-left py-1 pr-2">From</th>
                    <th class="text-left py-1 pr-2">To</th>
                    <th class="text-left py-1 pr-2">Date</th>
                    <th class="text-left py-1 pr-2">Dep</th>
                    <th class="text-left py-1 pr-2">Arr</th>
                    <th class="text-left py-1 pr-2">Class</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-white/10">
                  {% for seg in segs %}
                    <tr>
                      <td class="py-1 pr-2">{{ seg.get('carrier') or '' }}</td>
                      <td class="py-1 pr-2">{{ seg.get('flight_number') or '' }}</td>
                      <td class="py-1 pr-2">{{ seg.get('origin') or '' }}</td>
                      <td class="py-1 pr-2">{{ seg.get('destination') or '' }}</td>
                      <td class="py-1 pr-2">{{ seg.get('depart_date') or '' }}</td>
                      <td class="py-1 pr-2">{{ seg.get('depart_time_local') or '' }}</td>
                      <td class="py-1 pr-2">{{ seg.get('arrive_time_local') or '' }}</td>
                      <td class="py-1 pr-2">{{ seg.get('booking_class') or '' }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="space-y-3">
        <h2 class="text-xs uppercase tracking-[0.3em] text-white/50">Services</h2>
        {% for service in service_rows %}
          <div class="grid gap-3 rounded-2xl border border-white/10 bg-black/30 p-4 xl:grid-cols-6">
            <label class="flex flex-col gap-2 text-xs text-white/70 xl:col-span-2">
              Type
              <input name="services-{{ loop.index0 }}-type" value="{{ service.get('type') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70 xl:col-span-2">
              Description
              <input name="services-{{ loop.index0 }}-description" value="{{ service.get('description') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Carrier
              <input name="services-{{ loop.index0 }}-carrier" value="{{ service.get('carrier') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Route
              <input name="services-{{ loop.index0 }}-route" value="{{ service.get('route') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Departure date
              <input name="services-{{ loop.index0 }}-depart_date" value="{{ service.get('depart_date') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Departure time (local)
              <input name="services-{{ loop.index0 }}-depart_time_local" value="{{ service.get('depart_time_local') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              Arrival time (local)
              <input name="services-{{ loop.index0 }}-arrive_time_local" value="{{ service.get('arrive_time_local') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
            <label class="flex flex-col gap-2 text-xs text-white/70">
              PNR / reference
              <input name="services-{{ loop.index0 }}-pnr" value="{{ service.get('pnr') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
            </label>
          </div>
        {% endfor %}
      </div>

      <div class="space-y-4">
        <h2 class="text-xs uppercase tracking-[0.3em] text-white/50">Financials</h2>
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-3 rounded-2xl border border-white/10 bg-black/30 p-4">
            <p class="text-xs uppercase tracking-[0.3em] text-white/60">Grand total</p>
            <div class="grid gap-3 sm:grid-cols-[1fr,120px]">
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Amount
                <input name="grand_total_amount" value="{{ grand_total.get('amount') if grand_total.get('amount') is not none else '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Currency
                <input name="grand_total_currency" value="{{ grand_total.get('currency') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
            </div>
          </div>
          <div class="space-y-3 rounded-2xl border border-white/10 bg-black/30 p-4">
            <p class="text-xs uppercase tracking-[0.3em] text-white/60">Balance remaining</p>
            <div class="grid gap-3 sm:grid-cols-[1fr,120px]">
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Amount
                <input name="balance_amount" value="{{ balance_total.get('amount') if balance_total.get('amount') is not none else '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Currency
                <input name="balance_currency" value="{{ balance_total.get('currency') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="space-y-4">
        <h2 class="text-xs uppercase tracking-[0.3em] text-white/50">Payments</h2>
        <div class="grid gap-4 sm:grid-cols-2">
          <label class="flex flex-col gap-2 text-sm text-white/70">
            Last payment date
            <input name="last_payment_date" value="{{ payments.get('last_payment_date') or '' }}" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
          </label>
          <label class="flex flex-col gap-2 text-sm text-white/70">
            Last payment method
            <input name="last_payment_method" value="{{ payments.get('last_payment_method') or '' }}" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
          </label>
        </div>
        <div class="space-y-3">
          <h3 class="text-xs uppercase tracking-[0.3em] text-white/50">Transactions</h3>
          {% for txn in transactions_rows %}
            <div class="grid gap-3 rounded-2xl border border-white/10 bg-black/30 p-4 sm:grid-cols-5">
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Date
                <input name="transactions-{{ loop.index0 }}-date" value="{{ txn.get('date') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Amount
                <input name="transactions-{{ loop.index0 }}-amount" value="{{ txn.get('amount') if txn.get('amount') is not none else '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Currency
                <input name="transactions-{{ loop.index0 }}-currency" value="{{ txn.get('currency') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Method
                <input name="transactions-{{ loop.index0 }}-method" value="{{ txn.get('method') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
              <label class="flex flex-col gap-2 text-xs text-white/70">
                Reference
                <input name="transactions-{{ loop.index0 }}-reference" value="{{ txn.get('reference') or '' }}" class="rounded-2xl border border-white/10 bg-black/40 px-3 py-2 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              </label>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="space-y-3">
        <h2 class="text-xs uppercase tracking-[0.3em] text-white/50">Status</h2>
        <div class="grid gap-3 sm:grid-cols-3">
          <label class="flex flex-col gap-2 text-xs text-white/70">
            Stage
            {% set stage = status.get('stage') %}
            <select name="status_stage" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">
              <option value="">--</option>
              {% for option in ['Deposited', 'Booked', 'Completed', 'Cancelled'] %}
                <option value="{{ option }}" {% if stage == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="flex items-center gap-2 text-xs text-white/70">
            <input type="checkbox" name="documents_issued" value="true" class="h-4 w-4 rounded border-white/20 bg-black/30 text-accent focus:ring-accent" {% if status.get('documents_issued') %}checked{% endif %}>
            Documents issued
          </label>
          <label class="flex items-center gap-2 text-xs text-white/70">
            <input type="checkbox" name="travel_completed" value="true" class="h-4 w-4 rounded border-white/20 bg-black/30 text-accent focus:ring-accent" {% if status.get('travel_completed') %}checked{% endif %}>
            Travel completed
          </label>
        </div>
      </div>

      <label class="flex flex-col gap-2 text-sm text-white/70">
        Internal notes
        <textarea name="notes_field" rows="3" class="rounded-2xl border border-white/10 bg-black/30 px-4 py-3 text-white focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/50">{{ payload.get('notes') or '' }}</textarea>
      </label>

      <div class="flex justify-end">
        <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-accent px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-accent/30 transition hover:bg-accent/90">
          Save booking
        </button>
      </div>
    </section>
  </form>
</div>
{% endblock %}
